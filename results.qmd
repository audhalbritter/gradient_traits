---
title: "Understanding community assemblage using species and functional diversity across elevational gradients from the tropics to the arctic"
format:
    html:
      self-contained: false
  # pdf:
  #   documentclass: article
editor: visual
execute:
  echo: false
  error: true
  out-width: '100%'
---

```{r}
#| label: set-up
#| echo: false
#| warnings: false

library(targets)
library(tarchetypes)

```

## Introduction

Species and functional diversity are different metrics describing biodiversity and ecosystem function and they are affected by both abiotic and biotic filtering as well as the regional species pool. Species richness and functional diversity are expected to decrease towards high elevation and the arctic, due to stronger environmental filtering and fewer species in the species pool. These metrics can be used to understand how plant communities respond to different filters and how communities assembly along broad environmental gradients.

We assessed plant species diversity (i.e. species richness, evenness) and functional diversity (i.e. community weighted means and variance in leaf functional traits) along five elevational gradients in the arctic (Svalbard), boreal (Norway), , temperate (Colorado), sub-tropics (China) and tropic mountains (Peru). Specifically, we ask how plant communities respond to the environmental drivers along elevational gradients in terms of species and functional diversity? And how consistent these patterns are across a broad latitudinal gradient from the tropics to the arctic?

## Methods

We used species community composition and functional leaf trait data from all PFTC courses and RMBL in Colorado. The data represent the following ecosystems/countries: arctic (PFTC4 Svalbard), boreal (PFTC6 Norway), temperate (Colorado), sub-tropics (PFTC1 and 2 China) and tropics (PFTC3, Puna project and PFCT5 Peru). There are no chemical traits from Norway yet, and Norway was excluded from the multivariate analysis.

For some ecosystems there are several gradients, representing different management or environmental conditions. In Peru there is a gradient with more recent burning (B). In Svalbard there is a gradient with nutrient input from sea birds (N). For Norway there could be a separate gradient for grazing (G), but this is not included yet. I am unsure if we want to have these gradients or not.

The following diversity indices were calculated: Shannon diversity, Shannon evenness, species richness ( number of species) and sum of cover.

Size traits were log transformed. Trait means and higher moments were calculated using a trait imputation and bootstrapping with traitstrap (Maitner et al. 2023).

```{r}
#| label: tab-climate-summary
#| echo: false
#| warnings: false

library(gt)
library(dplyr)

# Load CHELSA climate data
tar_load(chelsa_extracted)

# Create summary table of climate variables by region
climate_summary <- chelsa_extracted |>
  group_by(region) |>
  summarise(
    `Growing Season Length (days)` = round(mean(`gsl_1981-2010_chelsa`, na.rm = TRUE), 1),
    `Growing Season Temperature (°C)` = round(mean(`gst_1981-2010_chelsa`, na.rm = TRUE), 1),
    `Growing Season Precipitation (mm)` = round(mean(`gsp_1981-2010_chelsa`, na.rm = TRUE), 1),
    `Potential Evapotranspiration (mm)` = round(mean(`pet_penman_mean_1981-2010_chelsa`, na.rm = TRUE), 1),
    .groups = "drop"
  ) |>
  # Reorder regions from north to south
  mutate(region = factor(region, levels = c("Svalbard", "Southern Scandes", "Rocky Mountains", 
                                           "Eastern Himalaya", "Central Andes", "Drakensberg"))) |>
  arrange(region)

# Create nice table with gt
climate_summary |>
  gt() |>
  tab_header(
    title = "Climate Summary by Region",
    subtitle = "Average growing season conditions across study sites"
  ) |>
  cols_label(
    region = "Region"
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) |>
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body(columns = everything())
  ) |>
  tab_options(
    table.font.size = 12,
    heading.title.font.size = 14,
    heading.subtitle.font.size = 12
  )

```

```{r}
#| label: fig-study-sites-map
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(regions_world_map)
regions_world_map

```

\newpage

## Results

### Diversity

This figure shows diversity indices (richness, Shannon diversity, and evenness) across the elevational gradient. The solid grey line represents the marginal prediction from mixed-effects models, while points are colored by region.

```{r}
#| label: fig-diversity-elev
#| echo: false
#| warnings: false
#| fig-height: 4

tar_load(diversity_fig)
diversity_fig

```

### Functional leaf traits

This figure shows the multivariate trait space for a subset of traits available across all regions. The ecosystems are well separated in trait space, with clear differentiation between regions.

```{r}
#| label: fig-trait-pca-full
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_pca_full_fig)
trait_pca_full_fig

```

\newpage

This figure shows the multivariate trait space including chemical traits. Norway is not part of this figure, because we do not have the chemical traits yet. The ecosystems are well separated in trait space, with the temperate and sub-tropic regions showing some overlap.

```{r}
#| label: fig-trait-pca
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_pca_fig)
trait_pca_fig

```

\newpage

This figure shows functional leaf traits in relation to growing season length (GEE). The solid grey line represents the marginal prediction from mixed-effects models, while points are colored by region.

```{r}
#| label: fig-trait-gsl
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_climate_gsl_fig)
trait_climate_gsl_fig

```

\newpage

This figure shows functional leaf traits in relation to growing season length (CHELSA). The solid grey line represents the marginal prediction from mixed-effects models, while points are colored by region.

```{r}
#| label: fig-trait-gsl-chelsa
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_climate_gsl_chelsa_fig)
trait_climate_gsl_chelsa_fig

```

\newpage

This figure shows functional leaf traits in relation to growing season temperature (CHELSA). The solid grey line represents the marginal prediction from mixed-effects models, while points are colored by region.

```{r}
#| label: fig-trait-gst
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_climate_gst_fig)
trait_climate_gst_fig

```

\newpage

This figure shows functional leaf traits in relation to growing season precipitation (CHELSA). The solid grey line represents the marginal prediction from mixed-effects models, while points are colored by region.

```{r}
#| label: fig-trait-gsp
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_climate_gsp_fig)
trait_climate_gsp_fig

```

\newpage

This figure shows functional leaf traits in relation to potential evapotranspiration (CHELSA). The solid grey line represents the marginal prediction from mixed-effects models, while points are colored by region.

```{r}
#| label: fig-trait-pet
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_climate_pet_fig)
trait_climate_pet_fig

```

\newpage

This figure shows functional leaf traits in relation to mean temperature of the warmest quarter (WorldClim). The solid grey line represents the marginal prediction from mixed-effects models, while points are colored by region.

```{r}
#| label: fig-trait-temp-warm
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_climate_temp_warm_fig)
trait_climate_temp_warm_fig

```

\newpage

This figure shows functional leaf traits in relation to precipitation of the warmest quarter (WorldClim). The solid grey line represents the marginal prediction from mixed-effects models, while points are colored by region.

```{r}
#| label: fig-trait-precip-warm
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_climate_precip_warm_fig)
trait_climate_precip_warm_fig

```

\newpage

This figure shows functional leaf traits in relation to mean diurnal range (WorldClim). The solid grey line represents the marginal prediction from mixed-effects models, while points are colored by region.

```{r}
#| label: fig-trait-diurnal
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_climate_diurnal_fig)
trait_climate_diurnal_fig

```

\newpage

This figure shows functional leaf traits in relation to annual temperature (WorldClim). The solid grey line represents the marginal prediction from mixed-effects models, while points are colored by region.

```{r}
#| label: fig-trait-annual-temp
#| echo: false
#| warnings: false
#| fig-height: 6

tar_load(trait_climate_annual_temp_fig)
trait_climate_annual_temp_fig

```

## Trait Model Results

### Model Quality Overview

This table shows the R² values for all trait-climate relationships, helping identify which models have good explanatory power versus those with poor fit.

```{r}
#| label: tab-model-quality
#| echo: false
#| warnings: false

library(gt)
library(dplyr)

tar_load(trait_model_r2_summary)

# Create a summary table of model quality
model_quality_table <- trait_model_r2_summary |>
  mutate(
    # Clean up trait names
    trait_clean = case_when(
      trait_trans == "plant_height_cm_log" ~ "Height cm",
      trait_trans == "dry_mass_g_log" ~ "Dry mass g",
      trait_trans == "leaf_area_cm2_log" ~ "Area cm²",
      trait_trans == "thickness_mm_log" ~ "Thickness mm",
      trait_trans == "ldmc" ~ "LDMC",
      trait_trans == "sla_cm2_g" ~ "SLA cm²/g",
      TRUE ~ stringr::str_replace_all(trait_trans, "_", " ") |> stringr::str_to_title()
    ),
    # Clean up predictor names
    predictor_clean = case_when(
      climate_variable == "growing_season_length" ~ "Growing Season Length (GEE)",
      climate_variable == "gsl_1981-2010_chelsa" ~ "Growing Season Length (CHELSA)",
      climate_variable == "gst_1981-2010_chelsa" ~ "Growing Season Temperature (CHELSA)",
      climate_variable == "gsp_1981-2010_chelsa" ~ "Growing Season Precipitation (CHELSA)",
      climate_variable == "pet_penman_mean_1981-2010_chelsa" ~ "Potential Evapotranspiration (CHELSA)",
      climate_variable == "mean_temperture_warmest_quarter_bioclim" ~ "Mean Temperature Warmest Quarter (WorldClim)",
      climate_variable == "precipitation_warmest_quarter_bioclim" ~ "Precipitation Warmest Quarter (WorldClim)",
      climate_variable == "diurnal_range_bioclim" ~ "Mean Diurnal Range (WorldClim)",
      climate_variable == "annual_temperature_bioclim" ~ "Annual Temperature (WorldClim)",
      TRUE ~ climate_variable
    ),
    # Round R² values
    r2_nakagawa = round(r2_nakagawa, 3),
    r2_conditional = round(r2_conditional, 3),
    aic = round(aic, 1),
    # Create quality categories
    quality = case_when(
      r2_nakagawa >= 0.3 ~ "Good",
      r2_nakagawa >= 0.1 ~ "Moderate", 
      r2_nakagawa >= 0.01 ~ "Poor",
      TRUE ~ "Very Poor"
    )
  ) |>
  select(trait_clean, predictor_clean, data_source, model_type, r2_nakagawa, r2_conditional, aic, quality, is_significant)

# Create the gt table
model_quality_table |>
  arrange(desc(r2_nakagawa)) |>
  gt() |>
  tab_header(
    title = "Trait Model Quality Summary",
    subtitle = "R² values and model fit statistics for trait-climate relationships"
  ) |>
  cols_label(
    trait_clean = "Trait",
    predictor_clean = "Climate Variable",
    r2_nakagawa = "Marginal R²",
    r2_conditional = "Conditional R²",
    aic = "AIC",
    quality = "Quality",
    is_significant = "Significant"
  ) |>
  tab_style(
    style = cell_text(weight = "bold", color = "green"),
    locations = cells_body(
      columns = everything(),
      rows = quality == "Good"
    )
  ) |>
  tab_style(
    style = cell_text(weight = "bold", color = "red"),
    locations = cells_body(
      columns = everything(),
      rows = quality == "Very Poor"
    )
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) |>
  tab_options(
    table.font.size = 10,
    heading.title.font.size = 14,
    heading.subtitle.font.size = 12
  )

```

### Detailed Model Results

```{r}
#| label: tab-trait-results
#| echo: false
#| warnings: false

library(gt)
library(dplyr)
library(tidyr)

tar_load(trait_models_output)

# Create a nice table of trait model results from the new long-format models
trait_results_table <- trait_models_output |>
  # Unnest the tidy results
  unnest(tidy_results) |>
  filter(effect == "fixed", term != "(Intercept)") |>  # Only fixed effects, exclude intercept
  mutate(
    # Clean up trait names using fancy names
    trait_clean = case_when(
      trait_trans == "plant_height_cm_log" ~ "Height cm",
      trait_trans == "dry_mass_g_log" ~ "Dry mass g",
      trait_trans == "leaf_area_cm2_log" ~ "Area cm²",
      trait_trans == "thickness_mm_log" ~ "Thickness mm",
      trait_trans == "ldmc" ~ "LDMC",
      trait_trans == "sla_cm2_g" ~ "SLA cm²/g",
      TRUE ~ stringr::str_replace_all(trait_trans, "_", " ") |> stringr::str_to_title()
    ),
    # Clean up predictor names using the climate_variable_clean from the data
    predictor_clean = case_when(
      climate_variable == "growing_season_length" ~ "Growing Season Length (GEE)",
      climate_variable == "gsl_1981-2010_chelsa" ~ "Growing Season Length (CHELSA)",
      climate_variable == "gst_1981-2010_chelsa" ~ "Growing Season Temperature (CHELSA)",
      climate_variable == "gsp_1981-2010_chelsa" ~ "Growing Season Precipitation (CHELSA)",
      climate_variable == "pet_penman_mean_1981-2010_chelsa" ~ "Potential Evapotranspiration (CHELSA)",
      climate_variable == "mean_temperture_warmest_quarter_bioclim" ~ "Mean Temperature Warmest Quarter (WorldClim)",
      climate_variable == "precipitation_warmest_quarter_bioclim" ~ "Precipitation Warmest Quarter (WorldClim)",
      climate_variable == "diurnal_range_bioclim" ~ "Mean Diurnal Range (WorldClim)",
      climate_variable == "annual_temperature_bioclim" ~ "Annual Temperature (WorldClim)",
      TRUE ~ climate_variable
    ),
    # Round numeric values
    estimate = round(estimate, 3),
    std.error = round(std.error, 3),
    statistic = round(statistic, 2),
    p.value = round(p.value, 3),
    # Create significance indicator for formatting
    is_significant = p.value < 0.05
  ) |>
  select(trait_clean, predictor_clean, estimate, std.error, statistic, df, p.value, is_significant)

# Create the gt table with proper ordering
trait_results_table |>
  arrange(predictor_clean, trait_clean) |>  # Sort by predictor first, then trait
  group_by(predictor_clean) |>
  gt() |>
  cols_hide(columns = c(predictor_clean, is_significant)) |>  # Hide predictor and significance columns
  tab_header(
    title = "Trait Model Results",
    subtitle = "Mixed-effects models showing relationships between functional traits and environmental predictors"
  ) |>
  cols_label(
    trait_clean = "Trait",
    estimate = "Estimate",
    std.error = "SE",
    statistic = "t-statistic",
    df = "df",
    p.value = "p-value"
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = everything(),
      rows = is_significant == TRUE
    )
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) |>
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body(columns = c(estimate, std.error, statistic, df, p.value))
  ) |>
  tab_options(
    table.font.size = 11,
    heading.title.font.size = 14,
    heading.subtitle.font.size = 12,
    column_labels.font.weight = "bold"
  )

```